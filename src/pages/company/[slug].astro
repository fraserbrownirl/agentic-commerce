---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { articles } from '../../data/articles';
import { acpCompanies } from '../../data/acpCompanies';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = () => {
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
};

const { article } = Astro.props;

const title = `${article.headline} | Agentic Commerce`;
const description = article.summary;
const canonical = `https://agentic.commerce/company/${article.slug}`;

const breadcrumbs = [
  { name: "Home", url: "https://agentic.commerce/" },
  { name: "Companies", url: "https://agentic.commerce/companies" },
  { name: article.companyName, url: canonical },
];

// Stagger dates per article using slug hash
const slugHash = article.slug.split('').reduce((acc: number, c: string) => acc + c.charCodeAt(0), 0);
const dayOffset = (slugHash % 20) + 1;
const publishDate = `2026-01-${String(dayOffset).padStart(2, '0')}`;

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": article.headline,
    "description": article.summary,
    "datePublished": publishDate,
    "dateModified": "2026-02-12",
    "author": { "@type": "Organization", "name": "Agentic Commerce" },
    "publisher": { "@type": "Organization", "name": "Agentic Commerce" },
    "about": { "@type": "Organization", "name": article.companyName },
    "keywords": `agentic commerce news, agentic commerce protocol, ${article.companyName}`,
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": breadcrumbs.map((b, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "name": b.name,
      "item": b.url,
    })),
  },
];

const bodyParagraphs = article.body.split('\n').filter((p: string) => p.trim().length > 0);

// Find related articles (excluding self)
const relatedArticles = articles.filter((a) => a.slug !== article.slug).slice(0, 3);

// Find this company in acpCompanies for a directory link
const acpEntry = acpCompanies.find((c) => c.slug === article.slug);
---

<BaseLayout title={title} description={description} canonical={canonical} ogType="article" jsonLd={jsonLd}>
  <article class="mx-auto max-w-3xl px-6 py-12">
    <Breadcrumbs items={breadcrumbs} />
    <p class="text-xs text-muted-foreground mb-4">Last updated: February 12, 2026</p>

    <p class="text-xs font-semibold uppercase tracking-widest text-accent mb-2">
      {article.companyName}
    </p>
    <h1 class="text-4xl font-bold mb-6">{article.headline}</h1>

    <!-- Summary callout -->
    <div class="border-l-4 border-accent pl-4 mb-8">
      <p class="text-base text-muted-foreground leading-relaxed italic">
        {article.summary}
      </p>
    </div>

    <!-- Article body -->
    <div class="space-y-4">
      {bodyParagraphs.map((paragraph: string) => (
        <p class="text-base leading-relaxed text-muted-foreground">{paragraph}</p>
      ))}
    </div>

    {/* Link to company directory page if it exists */}
    {acpEntry && (
      <div class="mt-8 p-4 border border-accent/30 bg-accent/5 rounded-lg">
        <p class="text-sm text-muted-foreground">
          View {article.companyName}'s full ACP profile and certification status.
          <a href={`/companies/${acpEntry.slug}`} class="text-accent hover:underline ml-1 font-medium">View company profile &rarr;</a>
        </p>
      </div>
    )}

    {/* Related articles */}
    <section class="mt-12 space-y-4">
      <h2 class="text-2xl font-bold">Related Articles</h2>
      <div class="grid md:grid-cols-3 gap-4">
        {relatedArticles.map((r) => (
          <a href={`/company/${r.slug}`} class="p-4 border border-border rounded-lg hover:border-accent transition-colors group">
            <p class="text-xs font-semibold uppercase tracking-widest text-accent mb-2">{r.companyName}</p>
            <h3 class="text-sm font-semibold group-hover:text-accent transition-colors line-clamp-2">{r.headline}</h3>
          </a>
        ))}
      </div>
    </section>

    <aside class="mt-12 p-4 border border-border rounded">
      <p class="text-sm text-muted-foreground">
        <a href="/companies" class="text-accent hover:underline">Browse all companies</a> in the agentic commerce ecosystem, or read
        <a href="/" class="text-accent hover:underline">the complete guide to agentic commerce</a>.
      </p>
    </aside>
  </article>
</BaseLayout>
